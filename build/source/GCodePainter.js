(function(e,t){typeof define=="function"&&define.amd?define([],t):e.gCodePainter=t()})(this,function(){var e=function(){function P(e){i=[],r=[],D(e.target.result),t=e.target.result.split(/\n/),n.getWorker().postMessage({cmd:"parseGCode",msg:{gcode:t,options:{firstReport:5}}})}function H(e){for(var t in e)T[t]=e[t]}function B(){T.sortLayers&&C(),T.purgeEmptyLayers&&k(),n.doPaint(i,0)}function j(e){i[e.layerNum]=e.cmds,r[e.zHeightObject.zValue]=e.zHeightObject.layer}function F(e){for(var t=0;t<e.layerNum.length;t++)i[e.layerNum[t]]=e.model[e.layerNum[t]],r[e.zHeightObject.zValue[t]]=e.layerNum[t]}function I(e){o=e.min,s=e.max,u=e.modelSize,c=e.totalFilament,a=e.filamentByLayer,f=e.filamentByExtruder,g=e.speeds,b=e.speedsByLayer,h=e.printTime,l=e.printTimeByLayer,d=e.layerHeight,v=e.layerCnt,m=e.layerTotal,w=e.volSpeeds,E=e.volSpeedsByLayer,S=e.extrusionSpeeds,x=e.extrusionSpeedsByLayer;var t=1;T.filamentType==="ABS"?t=1.04:T.filamentType==="PLA"&&(t=1.24),p=t*3.141*T.filamentDia/10*T.filamentDia/10/4*c/10,T.wh=parseFloat(T.nozzleDia)/parseFloat(d);if(y==="Slic3r"||y==="cura")T.wh=T.wh*1.1}function q(e){return a[e]}function R(e){return b[e]?b[e]:{}}function U(){return{min:o,max:s,modelSize:u,totalFilament:c,filamentByExtruder:f,speeds:g,speedsByLayer:b,printTime:h,printTimeByLayer:l,totalWeight:p,layerHeight:d,layerCnt:v,layerTotal:m,volSpeeds:w,volSpeedsByLayer:E,extrusionSpeeds:S,extrusionSpeedsByLayer:x}}function z(e,t,n){var r=0,s={first:i[e][t].gcodeLine,last:i[e][n].gcodeLine};return s}function W(){return T}var e,t,r={},i=[],s={x:undefined,y:undefined,z:undefined},o={x:undefined,y:undefined,z:undefined},u={x:undefined,y:undefined,z:undefined},a={},f={},l,c=0,h=0,p=0,d=0,v=0,m=0,g={},y="unknown",b={},w={},E={},S={},x={},T={sortLayers:!1,purgeEmptyLayers:!0,analyzeModel:!1,filamentType:"ABS",filamentDia:1.75,nozzleDia:.4},N=function(){if(!t)return;e=[];var n;for(n=0;n<t.length;n++)t[n].match(/^(G0|G1|G90|G91|G92|M82|M83|G28)/i)&&e.push(t[n]);t=[]},C=function(){var e=[],t=[];for(var n in r)e[r[n]]=n;e.sort(function(e,t){return e-t});for(var s=0;s<e.length;s++){if(typeof r[e[s]]=="undefined")continue;t[s]=i[r[e[s]]]}i=t},k=function(){var e=!0;if(!i){console.log("Something terribly wrong just happened.");return}for(var t=0;t<i.length;t++){e=!0;if(typeof i[t]=="undefined")e=!0;else for(var n=0;n<i[t].length;n++)i[t][n].extrude&&(e=!1);e&&(i.splice(t,1),t--)}},L=function(e){var t=e.match(/extrusion_width_mm\s*=\s*(\d*\.\d+)/m);t&&(T.nozzleDia=t[1]);var n=e.match(/fiber_dia_mm\s*=\s*(\d*\.\d+)/m);n&&(T.filamentDia=n[1])},A=function(e){var t=e.match(/nozzle_diameter\s*=\s*(\d*\.\d+)/m);t&&(T.nozzleDia=t[1]);var n=e.match(/filament_diameter\s*=\s*(\d*\.\d+)/m);n&&(T.filamentDia=n[1])},O=function(e){var t=e.match(/nozzle_diameter\s*=\s*(\d*\.\d+)/m);t&&(T.nozzleDia=t[1]);var n=e.match(/Filament_Diameter_(mm)\s*:\s*(\d*\.\d+)/m);n&&(T.filamentDia=n[1])},M=function(e){},_=function(e){var t=e.match(/CURA_PROFILE_STRING:((?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))/m);if(t){var n=window.atob(t[1]),r=new Uint8Array(new ArrayBuffer(n.length)),i=0;for(i=0;i<n.length;i++)r[i]=n.charCodeAt(i);var s=new Zlib.inflate(r.subarray(2,r.byteLength-4)),o;for(i=0;i<s.length;i+=1)o+=String.fromCharCode(s[i]);var u=o.match(/nozzle_size\s*=\s*(\d*\.\d+)/m);u&&(T.nozzleDia=u[1]);var a=o.match(/filament_diameter\s*=\s*(\d*\.\d+)/m);a&&(T.filamentDia=a[1])}},D=function(e){e.match(/Slic3r/)?(y="Slic3r",A(e)):e.match(/KISSlicer/)?(y="KISSlicer",L(e)):e.match(/skeinforge/)?(y="skeinforge",O(e)):e.match(/CURA_PROFILE_STRING/)?(y="cura",_(e)):e.match(/Miracle/)&&(y="makerbot",M(e))};return{loadFile:P,setOption:H,passDataToRenderer:B,processLayerFromWorker:j,processMultiLayerFromWorker:F,processAnalyzeModelDone:I,getLayerFilament:q,getLayerSpeeds:R,getModelInfo:U,getGCodeLines:z,getOptions:W}}(),t=function(){function P(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),n=t.createSVGMatrix();e.getTransform=function(){return n};var r=[],i=e.save;e.save=function(){return r.push(n.translate(0,0)),i.call(e)};var s=e.restore;e.restore=function(){return n=r.pop(),s.call(e)};var o=e.scale;e.scale=function(t,r){return n=n.scaleNonUniform(t,r),o.call(e,t,r)};var u=e.rotate;e.rotate=function(t){return n=n.rotate(t*180/Math.PI),u.call(e,t)};var a=e.translate;e.translate=function(t,r){return n=n.translate(t,r),a.call(e,t,r)};var f=e.transform;e.transform=function(r,i,s,o,u,a){var l=t.createSVGMatrix();return l.a=r,l.b=i,l.c=s,l.d=o,l.e=u,l.f=a,n=n.multiply(l),f.call(e,r,i,s,o,u,a)};var l=e.setTransform;e.setTransform=function(t,r,i,s,o,u){return n.a=t,n.b=r,n.c=i,n.d=s,n.e=o,n.f=u,l.call(e,t,r,i,s,o,u)};var c=t.createSVGPoint();e.transformedPoint=function(e,t){return c.x=e,c.y=t,c.matrixTransform(n.inverse())}}function F(e){H(e),S=!0,n.translate((e.width-s*r)/2,o*r+(e.height-o*r)/2)}function I(e){for(var t in e)e.hasOwnProperty(t)&&(T[t]=e[t]);S&&D()}function q(){return T}function R(){return E}function U(i,s,o){var u=e.getOptions();if(!S){console.error("gCodePainter canvas not initialized");return}if(!E)B();else if(i<E.length){var a=n.transformedPoint(0,0),f=n.transformedPoint(t.width,t.height);n.clearRect(a.x,a.y,f.x-a.x,f.y-a.y),B(),T.alpha?n.globalAlpha=.6:n.globalAlpha=1,T.actualWidth?T.extrusionWidth=u.filamentDia*u.wh/r:T.extrusionWidth=u.filamentDia*u.wh/r/2,T.showNextLayer&&i<E.length-1&&j(i+1,0,W(i+1),!0),j(i,s,o)}else console.log("Got request to render non-existent layer!!")}function z(){return E?E.length:1}function W(e){return E?E[e]?E[e].length:1:1}function X(e){U(e,0,E[e].length)}function V(i,u){var a;E=i,l=0,c=0,S||F(),a=e.getModelInfo(),k=a.speeds,L=a.speedsByLayer,A=a.volSpeeds,O=a.volSpeedsByLayer,M=a.extrusionSpeeds,_=a.extrusionSpeedsByLayer,N=(s/2-(a.min.x+a.modelSize.x/2))*r,C=(a.min.y+a.modelSize.y/2)*r-o/2*r,n&&n.translate(N,C);var f=a.modelSize.x>a.modelSize.y?t.width/a.modelSize.x/r:t.height/a.modelSize.y/r,h=n.transformedPoint(t.width/2,t.height/2),p=n.getTransform(),d=f/p.a,v=f/p.d;n.translate(h.x,h.y),n.scale(.98*d,.98*v),n.translate(-h.x,-h.y),U(u,1,E[u].length)}function $(e){if(!E&&!E[e])return"-1";var t=E[e];for(var n=0;n<t.length;n++)if(t[n].prevZ!==undefined)return t[n].prevZ;return"-1"}var t,n,r=3,i=.4,s=200,o=200,u=10,a,f,l=0,c=0,h,p,d,v={from:0,to:-1},m,g,y,b,w=1.1,E,S=!1,x={speed:1,expermm:2,volpersec:3},T={showMoves:!0,showRetracts:!0,colorGrid:"#bbbbbb",extrusionWidth:1,colorLine:["#000000","#45c7ba","#a9533a","#ff44cc","#dd1177","#eeee22","#ffbb55","#ff5511","#777788","#ff0000","#ffff00"],colorLineLen:9,colorMove:"#00ff00",colorRetract:"#ff0000",colorRestart:"#0000ff",sizeRetractSpot:2,modelCenter:{x:0,y:0},moveModel:!0,differentiateColors:!0,showNextLayer:!1,alpha:!1,actualWidth:!1,renderErrors:!1,renderAnalysis:!1,speedDisplayType:x.speed},N=0,C=0,k=[],L={},A=[],O={},M=[],_={},D=function(){var i=e.getOptions(),s=n.transformedPoint(0,0),o=n.transformedPoint(t.width,t.height);n.clearRect(s.x,s.y,o.x-s.x,o.y-s.y),B(),T.alpha?n.globalAlpha=.6:n.globalAlpha=1,T.actualWidth?T.extrusionWidth=i.filamentDia*i.wh/r:T.extrusionWidth=i.filamentDia*i.wh/r/2,T.showNextLayer&&d<E.length-1&&j(d+1,0,W(d+1),!0),j(d,v.from,v.to)},H=function(e){t=e;var r=t.getContext("2d");r.canvas.style.width="800px",r.canvas.style.height="600px",r.canvas.width=800,r.canvas.height=600;if(!t.getContext)throw"exception";n=t.getContext("2d"),a=t.height,f=t.width,m=f/2,g=a/2,n.lineWidth=2,n.lineCap="round",P(n)},B=function(){var e;n.strokeStyle=T.colorGrid,n.lineWidth=1;var t=0,i=0;T.moveModel&&(t=N,i=C),n.beginPath();for(e=0;e<=s;e+=u)n.moveTo(e*r-t,0-i),n.lineTo(e*r-t,-o*r-i);n.stroke(),n.beginPath();for(e=0;e<=o;e+=u)n.moveTo(0-t,-e*r-i),n.lineTo(s*r-t,-e*r-i);n.stroke()},j=function(e,t,i,s){var o,u=0,a=0;s=typeof s!="undefined"?s:!1,s||(d=e,v={from:t,to:i});if(!E||!E[e])return;var f=E[e],h,p;if(t>0)l=f[t-1].x*r,c=-f[t-1].y*r;else if(t===0&&e===0)E[0]&&typeof E[0].x!="undefined"&&typeof E[0].y!="undefined"?(l=E[0].x*r,c=-E[0].y*r):(l=0,c=0);else if(typeof f[0].prevX!="undefined"&&typeof f[0].prevY!="undefined")l=f[0].prevX*r,c=-f[0].prevY*r;else if(E[e-1]){l=undefined,c=undefined;for(o=E[e-1].length-1;o>=0;o--)typeof l=="undefined"&&E[e-1][o].x!==undefined&&(l=E[e-1][o].x*r),typeof c=="undefined"&&E[e-1][o].y!==undefined&&(c=-E[e-1][o].y*r);typeof l=="undefined"&&(l=0),typeof c=="undefined"&&(c=0)}else l=0,c=0;a=$(e);for(o=t;o<=i;o++){n.lineWidth=1;if(typeof f[o]=="undefined")continue;typeof f[o].prevX!="undefined"&&typeof f[o].prevY!="undefined"&&(l=f[o].prevX*r,c=-f[o].prevY*r),typeof f[o].x=="undefined"||isNaN(f[o].x)?h=l/r:h=f[o].x,typeof f[o].y=="undefined"||isNaN(f[o].y)?p=c/r:p=-f[o].y,T.differentiateColors&&!T.showNextLayer&&!T.renderAnalysis?(T.speedDisplayType===x.speed?u=k.extrude.indexOf(f[o].speed):T.speedDisplayType===x.expermm?u=A.indexOf(f[o].volPerMM):T.speedDisplayType===x.volpersec?u=M.indexOf((f[o].volPerMM*f[o].speed/60).toFixed(3)):u=0,u===-1?u=0:u>T.colorLineLen-1&&(u%=T.colorLineLen-1)):T.showNextLayer&&s?u=3:T.renderErrors?f[o].errType===2?u=9:f[o].errType===1?u=10:u=0:T.renderAnalysis?e!==0?u=-1:u=0:u=0;if(!f[o].extrude&&!f[o].noMove)f[o].retract==-1&&T.showRetracts&&(n.strokeStyle=T.colorRestart,n.fillStyle=T.colorRestart,n.beginPath(),n.arc(l,c,T.sizeRetractSpot,0,Math.PI*2,!0),n.stroke(),n.fill()),T.showMoves&&(n.strokeStyle=T.showMoves,n.beginPath(),n.moveTo(l,c),n.lineTo(h*r,p*r),n.stroke());else if(f[o].extrude)if(f[o].retract===0){if(u>=0)n.strokeStyle=T.colorLine[u];else if(u===-1){var m=parseInt(f[o].errLevelB).toString(16),g="#"+"00".substr(0,2-m.length)+m+"0000";m=parseInt(f[o].errLevelE).toString(16);var y="#"+"00".substr(0,2-m.length)+m+"0000",b=n.createLinearGradient(l,c,h*r,p*r),w;f[o].errType===1?(w=1-f[o].errDelimiter,w>=.99&&(w=.99),b.addColorStop(0,"#000000"),b.addColorStop(w,"#000000"),b.addColorStop(w+.01,y),b.addColorStop(1,y)):f[o].errType===2?(b.addColorStop(0,g),w=f[o].errDelimiter,w>=.99&&(w=.99),b.addColorStop(w,g),b.addColorStop(w+.01,"#000000"),b.addColorStop(1,"#000000")):(b.addColorStop(0,g),b.addColorStop(1,y)),n.strokeStyle=b}n.lineWidth=T.extrusionWidth,n.beginPath(),n.moveTo(l,c),n.lineTo(h*r,p*r),n.stroke()}else T.showRetracts&&(n.strokeStyle=T.colorRestart,n.fillStyle=T.colorRestart,n.beginPath(),n.arc(l,c,T.sizeRetractSpot,0,Math.PI*2,!0),n.stroke(),n.fill());l=h*r,c=p*r}n.stroke()};return{init:F,setOption:I,getOptions:q,debugGetModel:R,render:U,getModelNumLayers:z,getLayerNumSegments:W,renderLayer:X,doRender:V,getZ:$}}(),n=function(){function s(e){o(e),u()}function o(e){i=document.createElement("canvas"),document.getElementById(e).appendChild(i),t.init(i)}function u(){var i="";r=new Worker("source/GCodeWorker.js"),r.onmessage=function(s){var o=s.data;switch(o.cmd){case"returnModel":r.postMessage({cmd:"analyzeModel",msg:{}});break;case"analyzeDone":n.onParseProgress(100),e.processAnalyzeModelDone(o.msg),e.passDataToRenderer(),document.getElementById("gcodeRangeSlider").max=t.getModelNumLayers()-1;break;case"returnLayer":e.processLayerFromWorker(o.msg);break;case"returnMultiLayer":e.processMultiLayerFromWorker(o.msg),i+=".",n.onParseProgress("loading "+i),i.length>4&&(i=".");break;case"analyzeProgress":i+=".",n.onParseProgress("loading "+i),i.length>4&&(i=".");break;default:console.log("default msg received"+o.cmd)}}}function a(t){var n=new FileReader;n.onload=function(t){e.loadFile(t)},n.readAsText(t)}function f(t){var n={target:{result:null}},r=new XMLHttpRequest;r.overrideMimeType("text/plain"),r.open("GET",t,!0),r.addEventListener("load",function(t){var r=t.target.response;n.target.result=r,this.status===200?e.loadFile(n):this.status===0&&(console.warn("HTTP Status 0 received."),e.loadFile(n))},!1),r.send(null)}function l(e,n){t.doRender(e,n)}function c(){return r}function h(e){t.renderLayer(e)}function p(e){document.getElementById("StatePanel").innerHTML=e}var r=null,i=null;return{init:s,loadFile:a,loadUrl:f,doPaint:l,getWorker:c,paintLayer:h,onParseProgress:p}}();return n});