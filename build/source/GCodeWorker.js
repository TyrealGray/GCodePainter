var gCodeReadWorker=self,gcode,firstReport,z_heights={},model=[],gCodeOptions={sortLayers:!1,purgeEmptyLayers:!0,analyzeModel:!1},max={x:undefined,y:undefined,z:undefined},min={x:undefined,y:undefined,z:undefined},modelSize={x:undefined,y:undefined,z:undefined},filamentByLayer={},filamentByExtruder={},totalFilament=0,printTime=0,printTimeByLayer={},layerHeight=0,layerCnt=0,speeds={extrude:[],retract:[],move:[]},speedsByLayer={extrude:{},retract:{},move:{}},volSpeeds=[],volSpeedsByLayer={},extrusionSpeeds=[],extrusionSpeedsByLayer={},sendLayerToParent=function(e,t,n){gCodeReadWorker.postMessage({cmd:"returnLayer",msg:{cmds:model[e],layerNum:e,zHeightObject:{zValue:t,layer:z_heights[t]},isEmpty:!1,progress:n}})},sendMultiLayerToParent=function(e,t,n){var r=[],i={};for(var s=0;s<e.length;s++)r[e[s]]=model[e[s]],i[e[s]]=z_heights[t[s]];gCodeReadWorker.postMessage({cmd:"returnMultiLayer",msg:{model:r,layerNum:e,zHeightObject:{zValue:t,layer:i},isEmpty:!1,progress:n}})},sendSizeProgress=function(e){gCodeReadWorker.postMessage({cmd:"analyzeProgress",msg:{progress:e,printTime:printTime}})},sendAnalyzeDone=function(){gCodeReadWorker.postMessage({cmd:"analyzeDone",msg:{max:max,min:min,modelSize:modelSize,totalFilament:totalFilament,filamentByLayer:filamentByLayer,filamentByExtruder:filamentByExtruder,printTime:printTime,layerHeight:layerHeight,layerCnt:layerCnt,layerTotal:model.length,speeds:speeds,speedsByLayer:speedsByLayer,volSpeeds:volSpeeds,volSpeedsByLayer:volSpeedsByLayer,printTimeByLayer:printTimeByLayer,extrusionSpeeds:extrusionSpeeds,extrusionSpeedsByLayer:extrusionSpeedsByLayer}})},purgeLayers=function(){var e=!0;for(var t=0;t<model.length;t++){e=!0;if(!model[t])e=!0;else for(var n=0;n<model[t].length;n++)model[t][n].extrude&&(e=!1);e||(layerCnt+=1)}},analyzeModel=function(){var e,t,n=!1,r=!1,i,s=0,o=0,u=0,a,f=0;for(e=0;e<model.length;e++){i=model[e];if(!i)continue;for(t=0;t<i.length;t++){n=!1,r=!1,typeof i[t].x!="undefined"&&typeof i[t].prevX!="undefined"&&typeof i[t].extrude!="undefined"&&i[t].extrude&&!isNaN(i[t].x)&&(max.x=parseFloat(max.x)>parseFloat(i[t].x)?parseFloat(max.x):parseFloat(i[t].x),max.x=parseFloat(max.x)>parseFloat(i[t].prevX)?parseFloat(max.x):parseFloat(i[t].prevX),min.x=parseFloat(min.x)<parseFloat(i[t].x)?parseFloat(min.x):parseFloat(i[t].x),min.x=parseFloat(min.x)<parseFloat(i[t].prevX)?parseFloat(min.x):parseFloat(i[t].prevX),n=!0),typeof i[t].y!="undefined"&&typeof i[t].prevY!="undefined"&&typeof i[t].extrude!="undefined"&&i[t].extrude&&!isNaN(i[t].y)&&(max.y=parseFloat(max.y)>parseFloat(i[t].y)?parseFloat(max.y):parseFloat(i[t].y),max.y=parseFloat(max.y)>parseFloat(i[t].prevY)?parseFloat(max.y):parseFloat(i[t].prevY),min.y=parseFloat(min.y)<parseFloat(i[t].y)?parseFloat(min.y):parseFloat(i[t].y),min.y=parseFloat(min.y)<parseFloat(i[t].prevY)?parseFloat(min.y):parseFloat(i[t].prevY),r=!0),typeof i[t].prevZ!="undefined"&&typeof i[t].extrude!="undefined"&&i[t].extrude&&!isNaN(i[t].prevZ)&&(max.z=parseFloat(max.z)>parseFloat(i[t].prevZ)?parseFloat(max.z):parseFloat(i[t].prevZ),min.z=parseFloat(min.z)<parseFloat(i[t].prevZ)?parseFloat(min.z):parseFloat(i[t].prevZ));if(typeof i[t].extrude!="undefined"&&i[t].extrude===!0||i[t].retract!==0)totalFilament+=i[t].extrusion,filamentByLayer[i[t].prevZ]||(filamentByLayer[i[t].prevZ]=0),filamentByLayer[i[t].prevZ]+=i[t].extrusion,i[t].extruder!==null&&(filamentByExtruder[i[t].extruder]||(filamentByExtruder[i[t].extruder]=0),filamentByExtruder[i[t].extruder]+=i[t].extrusion);n&&r?f=Math.sqrt(Math.pow(parseFloat(i[t].x)-parseFloat(i[t].prevX),2)+Math.pow(parseFloat(i[t].y)-parseFloat(i[t].prevY),2))/(i[t].speed/60):i[t].retract===0&&i[t].extrusion!==0?(s=Math.sqrt(Math.pow(parseFloat(i[t].x)-parseFloat(i[t].prevX),2)+Math.pow(parseFloat(i[t].y)-parseFloat(i[t].prevY),2))/(i[t].speed/60),o=Math.abs(parseFloat(i[t].extrusion)/(i[t].speed/60)),f=s>=o?s:o):i[t].retract!==0&&(f=Math.abs(parseFloat(i[t].extrusion)/(i[t].speed/60))),printTime+=f,typeof printTimeByLayer[i[t].prevZ]=="undefined"&&(printTimeByLayer[i[t].prevZ]=0),printTimeByLayer[i[t].prevZ]+=f,i[t].extrude&&i[t].retract===0?a="extrude":i[t].retract!==0?a="retract":!i[t].extrude&&i[t].retract===0?a="move":(gCodeReadWorker.postMessage({cmd:"unknown type of move"}),a="unknown"),u=speeds[a].indexOf(i[t].speed),u===-1&&(speeds[a].push(i[t].speed),u=speeds[a].indexOf(i[t].speed)),typeof speedsByLayer[a][i[t].prevZ]=="undefined"&&(speedsByLayer[a][i[t].prevZ]=[]),speedsByLayer[a][i[t].prevZ].indexOf(i[t].speed)===-1&&(speedsByLayer[a][i[t].prevZ][u]=i[t].speed);if(i[t].extrude&&i[t].retract===0&&n&&r){var l=i[t].volPerMM;l=parseFloat(l).toFixed(3);var c=volSpeeds.indexOf(l);c===-1&&(volSpeeds.push(l),c=volSpeeds.indexOf(l)),typeof volSpeedsByLayer[i[t].prevZ]=="undefined"&&(volSpeedsByLayer[i[t].prevZ]=[]),volSpeedsByLayer[i[t].prevZ].indexOf(l)===-1&&(volSpeedsByLayer[i[t].prevZ][c]=l);var h=i[t].volPerMM*(i[t].speed/60);h=parseFloat(h).toFixed(3),c=extrusionSpeeds.indexOf(h),c===-1&&(extrusionSpeeds.push(h),c=extrusionSpeeds.indexOf(h)),typeof extrusionSpeedsByLayer[i[t].prevZ]=="undefined"&&(extrusionSpeedsByLayer[i[t].prevZ]=[]),extrusionSpeedsByLayer[i[t].prevZ].indexOf(h)===-1&&(extrusionSpeedsByLayer[i[t].prevZ][c]=h)}}sendSizeProgress(e/model.length*100)}purgeLayers(),modelSize.x=Math.abs(max.x-min.x),modelSize.y=Math.abs(max.y-min.y),modelSize.z=Math.abs(max.z-min.z),layerHeight=(max.z-min.z)/(layerCnt-1),sendAnalyzeDone()},doParse=function(){var e,t;model=[];var n,r=0,i=[],s=[],o=0,u=new RegExp(/^(?:G0|G1)\s/i),a=new RegExp,f,l=0,c=!1,h={e:0,a:0,b:0,c:0},p=0,d,v,m=0,g,y=0,b,w,E=4e3,S={a:undefined,b:undefined,c:undefined,e:undefined,abs:undefined},x=!1,T,N,C=!1,k=!1,L;for(var A=0;A<gcode.length;A++){d=undefined,v=undefined,m=undefined,T=undefined,p=0,c=!1,N=null,S.abs=0,gcode[A]=gcode[A].split(/[\(;]/)[0];if(u.test(gcode[A])){L=gcode[A].split(/\s/);for(f=0;f<L.length;f++){e=L[f].charAt(0).toLowerCase();switch(e){case"x":d=L[f].slice(1);break;case"y":v=L[f].slice(1);break;case"z":m=L[f].slice(1),m=Number(m);if(m==y)continue;z_heights.hasOwnProperty(m)?l=z_heights[m]:(l=model.length,z_heights[m]=l),n=l,r=m,y=m;break;case"e":case"a":case"b":case"c":k=!0,N=e,t=parseFloat(L[f].slice(1)).toFixed(6),x?S.abs=parseFloat(t):S.abs=parseFloat(t)-parseFloat(S[e]),c=S.abs>0,S.abs<0?(h[N]=-1,p=-1):S.abs===0?p=0:S.abs>0&&h[N]<0?(h[N]=0,p=1):p=0,S[e]=t;break;case"f":t=L[f].slice(1),E=t;break;default:}}C&&!k&&(c=!0,S.abs=Math.sqrt((b-d)*(b-d)+(w-v)*(w-v))),c&&p===0&&(T=Number(S.abs/Math.sqrt((b-d)*(b-d)+(w-v)*(w-v)))),model[l]||(model[l]=[]),model[l][model[l].length]={x:Number(d),y:Number(v),z:Number(m),extrude:c,retract:Number(p),noMove:!1,extrusion:c||p?Number(S.abs):0,extruder:N,prevX:Number(b),prevY:Number(w),prevZ:Number(y),speed:Number(E),gcodeLine:Number(A),volPerMM:typeof T=="undefined"?-1:T},typeof d!="undefined"&&(b=d),typeof v!="undefined"&&(w=v)}else if(gcode[A].match(/^(?:M82)/i))x=!1;else if(gcode[A].match(/^(?:G91)/i))x=!0;else if(gcode[A].match(/^(?:G90)/i))x=!1;else if(gcode[A].match(/^(?:M83)/i))x=!0;else if(gcode[A].match(/^(?:M101)/i))C=!0;else if(gcode[A].match(/^(?:M103)/i))C=!1;else if(gcode[A].match(/^(?:G92)/i)){L=gcode[A].split(/\s/);for(f=0;f<L.length;f++){e=L[f].charAt(0).toLowerCase();switch(e){case"x":d=L[f].slice(1);break;case"y":v=L[f].slice(1);break;case"z":m=L[f].slice(1),y=m;break;case"e":case"a":case"b":case"c":t=parseFloat(L[f].slice(1)).toFixed(3),N=e,x?S[e]=t:S[e]=0;break;default:}}model[l]||(model[l]=[]);if(typeof d!="undefined"||typeof v!="undefined"||typeof m!="undefined")model[l][model[l].length]={x:parseFloat(d),y:parseFloat(v),z:parseFloat(m),extrude:c,retract:parseFloat(p),noMove:!0,extrusion:0,extruder:N,prevX:parseFloat(b),prevY:parseFloat(w),prevZ:parseFloat(y),speed:parseFloat(E),gcodeLine:parseFloat(A)}}else if(gcode[A].match(/^(?:G28)/i)){L=gcode[A].split(/\s/);for(f=0;f<L.length;f++){e=L[f].charAt(0).toLowerCase();switch(e){case"x":d=L[f].slice(1);break;case"y":v=L[f].slice(1);break;case"z":m=L[f].slice(1),m=Number(m);if(m===y)continue;n=l,r=m,z_heights.hasOwnProperty(m)?l=z_heights[m]:(l=model.length,z_heights[m]=l),y=m;break;default:}}L.length==1,l===0&&typeof m=="undefined"&&(m=0,z_heights.hasOwnProperty(m)?l=z_heights[m]:(l=model.length,z_heights[m]=l),y=m),model[l]||(model[l]=[]),model[l][model[l].length]={x:Number(d),y:Number(v),z:Number(m),extrude:c,retract:Number(p),noMove:!1,extrusion:c||p?Number(S.abs):0,extruder:N,prevX:Number(b),prevY:Number(w),prevZ:Number(y),speed:Number(E),gcodeLine:Number(A)}}typeof n!="undefined"&&(A-o>gcode.length*.02&&i.length!==0&&(o=A,sendMultiLayerToParent(i,s,A/gcode.length*100),i=[],s=[]),i[i.length]=n,s[s.length]=r,n=undefined,r=undefined)}sendMultiLayerToParent(i,s,A/gcode.length*100)},parseGCode=function(e){gcode=e.gcode,firstReport=e.options.firstReport,doParse(),gcode=[],gCodeReadWorker.postMessage({cmd:"returnModel",msg:{}})},runAnalyze=function(e){analyzeModel(),model=[],z_heights=[],gcode=undefined,firstReport=undefined,z_heights={},model=[],max={x:undefined,y:undefined,z:undefined},min={x:undefined,y:undefined,z:undefined},modelSize={x:undefined,y:undefined,z:undefined},filamentByLayer={},filamentByExtruder={},totalFilament=0,printTime=0,printTimeByLayer={},layerHeight=0,layerCnt=0,speeds={extrude:[],retract:[],move:[]},speedsByLayer={extrude:{},retract:{},move:{}}},setOption=function(e){for(var t in e)gCodeOptions[t]=e[t]};gCodeReadWorker.onmessage=function(e){var t=e.data;switch(t.cmd){case"parseGCode":parseGCode(t.msg);break;case"setOption":setOption(t.msg);break;case"analyzeModel":runAnalyze(t.msg);break;default:gCodeReadWorker.postMessage("Unknown command: "+t.msg)}},setTimeout(function(){gCodeReadWorker.postMessage({cmd:" loaded"})},1e3);